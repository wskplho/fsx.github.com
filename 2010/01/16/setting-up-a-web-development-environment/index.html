<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Setting up a web development environment — Blog — 61924.nl</title>
<!--[if IE]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<!-- <link rel="stylesheet/less" type="text/css" href="http://61924.nl/assetsscreen.less"> -->
<link href='http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link rel="stylesheet" type="text/css" href="http://61924.nl/assets/all.css">
<link rel="alternate" type="application/atom+xml" href="http://61924.nl/atom.xml" />
</head>
<body id="blog-section">
<nav id="navigation">
<h1>61924</h1>
<div>

<a id="nav-blog" href="http://61924.nl/">blog</a>

<a id="nav-archive" href="http://61924.nl/archive/">archive</a>

<a id="nav-projects" href="http://61924.nl/projects/">projects</a>

<a id="nav-about" href="http://61924.nl/about/">about</a>

</div>
</nav>
<section id="content">

<article class="post">
<header>
<h1>Setting up a web development environment</h1>
<h2>16 Jan 2010</h2>
</header>
<p><strong>Note:</strong> Obsolete. Check the Arch Linux Wiki.</p>

<p>This Monday I was planning to cleanup and reorganize my web development server.
Everything was dumped in my home directory and I used some simple scripts to
start the services I needed (manually, each time I booted my server). So it was
time for some spring cleaning.</p>

<p>I&#39;m using <a href="http://archlinux.org/">Arch Linux</a> and you&#39;ll need it to follow this
article. Unless you know how to do everything on other GNU/Linux distros. If
you don&#39;t use Arch Linux just hook up an old computer and start reading the
<a href="http://wiki.archlinux.org/index.php/Beginners&#x27;_Guide">Beginners&#39; Guide</a> and
install Arch Linux. After you&#39;ve done that install
<a href="http://wiki.archlinux.org/index.php/SSH">SSH</a>.</p>

<h2>Software</h2>

<p>There&#39;s some software we need that is only available on the <a href="http://aur.archlinux.org/">AUR</a>.
So install <a href="http://aur.archlinux.org/packages.php?ID=33378">packer</a>,
<a href="http://aur.archlinux.org/packages.php?ID=5863">yaourt</a> or any other tools you like.</p>

<p>Here are the packages you need:</p>

<ul>
<li><a href="http://aur.archlinux.org/packages.php?ID=18036">nginx-unstable</a></li>
<li>mysql</li>
<li>php</li>
<li>php-cgi</li>
<li>phpmyadmin</li>
</ul>

<p>Install these packages. I&#39;ll explain how you can configure these later in the
article. <strong>php-cgi</strong> only has to be installed and doesn&#39;t need any further
configuration.</p>

<p>I&#39;m not going to explain how to configure MySQL, because I&#39;m just using the
default configuration from the <a href="http://wiki.archlinux.org/index.php/MySQL">ArchWiki</a>.
Just follow the instructions on that wiki article.</p>

<h2>Users &amp; Groups</h2>

<p>It&#39;s not really safe to run the webserver and PHP as root. We&#39;ll make a new user
and usergroup, both are called <strong>www</strong>, which is going to be used for PHP and
Nginx.</p>

<p>Run the following commands as root:</p>
<pre class="highlight"><code><span class="gp">$</span> groupadd www
<span class="gp">$</span> useradd -g www www
<span class="gp">$</span> chmod +w /srv/http/nginx
<span class="gp">$</span> chown -R www:www /srv/http/nginx
</code></pre>
<p>Make sure <strong>www</strong> is the owner of all the files and directories inside
<code>/srv/http/nginx</code>.</p>

<h2>Subdomains</h2>

<p><a href="http://www.medorion.net/">Medorion</a> helped me with this one. He knows a lot
about this kind of stuff.</p>

<p>To use subdomains you&#39;ll have to edit the hosts file of the the client.
The client is the computer you use to connect to the server, that means you
shouldn&#39;t touch the hosts file of the server.</p>

<p>Make sure you know the IP address and the hostname of your server.
Then open <code>/etc/hosts</code> and add the subdomains you would like to use.
In Windows the hosts file is located at <code>%SystemRoot%\system32\drivers\etc\</code>
and at <code>/private/etc/hosts</code> for Mac OS X.</p>

<p>Here&#39;s an example of my hosts file:</p>

<pre class="highlight"><code>#
# /etc/hosts: static lookup table for host names
#

#&lt;ip-address&gt;   &lt;hostname.domain.org&gt;   &lt;hostname&gt;
127.0.0.1               localhost.localdomain   localhost

# Subdomains for isamu
192.168.1.72    isamu
192.168.1.72    php.isamu
192.168.1.72    static.isamu

# These are optional
192.168.1.72    61924.isamu
192.168.1.72    medorion.isamu
192.168.1.72    shinobu.isamu
192.168.1.72    imgbrowz0r.isamu
192.168.1.72    fluxbb.isamu
192.168.1.72    anime.isamu
192.168.1.72    hg.isamu

# This one is required
192.168.1.72    phpmyadmin.isamu

# End of file</code></pre>

<p>You can decide by yourself which subdomains you want, but the <strong>phpmyadmin</strong>
subdomain is required, because we&#39;ll be configuring phpMyAdmin later in this
article. Just replace the IP address and <code>isamu</code> with the IP address and
hostname of your machine.</p>

<p>Restart your computer or reconnect to your network (<code>/etc/rc.d/network restart</code>)
after you have added the subdomains.</p>

<h3>Virtual hosts in Nginx</h3>

<p>Go to your server (or use SSH) and go to <code>/srv/http/nginx</code>. Create a bunch of
directories for your subdomains and move the <code>index.html</code> and <code>50x.html</code> into
a directory called <code>default</code> (create it if it doesn&#39;t exist).</p>
<pre class="highlight"><code><span class="gp">$</span> mkdir php static 61924 medorion shinobu imgbrowz0r fluxbb anime hg
<span class="gp">$</span> ls default/
<span class="go">50x.html  index.html</span>
<span class="gp">$</span> ls -F
<span class="go">61924/  anime/  default/  fluxbb/ hg/  imgbrowz0r/  medorion/  php/  shinobu/  static/</span>
</code></pre>
<p>And now we will make the needed changes to the Nginx configuration file,
which is located at <code>/etc/nginx/nginx.conf</code>.</p>

<p>Here&#39;s a part of the configuration file:</p>
<pre class="highlight"><code><span class="k">user</span>  <span class="s">www</span> <span class="s">www</span><span class="p">;</span> <span class="c1"># The user and group that Nginx uses (important)</span>
<span class="k">worker_processes</span>  <span class="mi">1</span><span class="p">;</span>

<span class="c1">#error_log  logs/error.log;</span>
<span class="c1">#error_log  logs/error.log  notice;</span>
<span class="c1">#error_log  logs/error.log  info;</span>

<span class="c1">#pid        logs/nginx.pid;</span>

<span class="k">events</span> <span class="p">{</span>
    <span class="kn">worker_connections</span>  <span class="mi">1024</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">http</span> <span class="p">{</span>
    <span class="kn">include</span>       <span class="s">mime.types</span><span class="p">;</span>
    <span class="kn">default_type</span>  <span class="s">application/octet-stream</span><span class="p">;</span>

    <span class="kn">log_format</span>  <span class="s">main</span>  <span class="s">&#39;</span><span class="nv">$remote_addr</span> <span class="s">-</span> <span class="nv">$remote_user</span> <span class="s">[</span><span class="nv">$time_local]</span> <span class="s">&quot;</span><span class="nv">$request&quot;</span> <span class="s">&#39;</span>
                      <span class="s">&#39;</span><span class="nv">$status</span> <span class="nv">$body_bytes_sent</span> <span class="s">&quot;</span><span class="nv">$http_referer&quot;</span> <span class="s">&#39;</span>
                      <span class="s">&#39;&quot;</span><span class="nv">$http_user_agent&quot;</span> <span class="s">&quot;</span><span class="nv">$http_x_forwarded_for&quot;&#39;</span><span class="p">;</span>

    <span class="kn">sendfile</span>           <span class="no">on</span><span class="p">;</span>
    <span class="kn">keepalive_timeout</span>  <span class="mi">65</span><span class="p">;</span>
    <span class="kn">gzip</span>               <span class="no">on</span><span class="p">;</span>

    <span class="c1"># Default: isamu</span>
    <span class="kn">server</span> <span class="p">{</span>
        <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
        <span class="kn">server_name</span>  <span class="s">isamu</span><span class="p">;</span>

        <span class="kn">root</span> <span class="s">/srv/http/nginx/default</span><span class="p">;</span>
        <span class="kn">access_log</span>  <span class="s">/var/log/nginx/isamu.access.log</span>  <span class="s">main</span><span class="p">;</span>
        <span class="kn">autoindex</span> <span class="no">on</span><span class="p">;</span>

        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
            <span class="kn">index</span>  <span class="s">index.html</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1"># Redirect server error pages to the static page /50x.html</span>
        <span class="kn">error_page</span>   <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span>  <span class="s">/50x.html</span><span class="p">;</span>
        <span class="kn">location</span> <span class="p">=</span> <span class="s">/50x.html</span> <span class="p">{</span>
            <span class="kn">root</span> <span class="s">/srv/http/nginx/default</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># static.isamu</span>
    <span class="kn">server</span> <span class="p">{</span>
        <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
        <span class="kn">server_name</span>  <span class="s">static.isamu</span><span class="p">;</span>

        <span class="kn">root</span> <span class="s">/srv/http/nginx/static</span><span class="p">;</span>
        <span class="kn">access_log</span>  <span class="s">/var/log/nginx/static.isamu.access.log</span>  <span class="s">main</span><span class="p">;</span>
        <span class="kn">autoindex</span> <span class="no">on</span><span class="p">;</span>

        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
            <span class="kn">index</span>  <span class="s">index.html</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1"># Redirect server error pages to the static page /50x.html</span>
        <span class="kn">error_page</span>   <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span>  <span class="s">/50x.html</span><span class="p">;</span>
        <span class="kn">location</span> <span class="p">=</span> <span class="s">/50x.html</span> <span class="p">{</span>
            <span class="kn">root</span> <span class="s">/srv/http/nginx/default</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>I&#39;ve only added one subdomain as you can see. You can just copy the server section
of <code>static.isamu</code> and change the <code>server_name</code>, <code>access_log</code> and <code>root</code> to
create all the other sections for the subdomains you want.</p>

<p>Here&#39;s an example:</p>
<pre class="highlight"><code><span class="c1"># php.isamu</span>
<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span>  <span class="s">php.isamu</span><span class="p">;</span>

    <span class="kn">root</span> <span class="s">/srv/http/nginx/php</span><span class="p">;</span>
    <span class="kn">access_log</span>  <span class="s">/var/log/nginx/php.isamu.access.log</span>  <span class="s">main</span><span class="p">;</span>
    <span class="kn">autoindex</span> <span class="no">on</span><span class="p">;</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">index</span>  <span class="s">index.html</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1"># Redirect server error pages to the static page /50x.html</span>
    <span class="kn">error_page</span>   <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span>  <span class="s">/50x.html</span><span class="p">;</span>
    <span class="kn">location</span> <span class="p">=</span> <span class="s">/50x.html</span> <span class="p">{</span>
        <span class="kn">root</span> <span class="s">/srv/http/nginx/default</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Do this for all the subdomains you want and start (or restart) Nginx to test
your subdomains.</p>
<pre class="highlight"><code><span class="gp">$</span> /etc/rc.d/nginx start
<span class="go">:: Starting Nginx                                               [DONE]</span>
</code></pre>
<h2>PHP</h2>

<p>At the moment Nginx can only serve static content. So we&#39;ll use PHP to make
life a bit more exciting.</p>

<p>First we will add an init script which I got from the
<a href="http://wiki.archlinux.org/index.php/Nginx#Use_PHP.2FPython_with_nginx">ArchWiki</a>.
I&#39;ve edited the script a bit, because there&#39;s a chance that we will need to run
more Fastcgi daemons.</p>

<p>Add the following init script to <code>/etc/rc.d</code> and call it <code>php-fastcgi</code>.</p>
<pre class="highlight"><code><span class="c">#!/bin/bash</span>

. /etc/rc.conf
. /etc/rc.d/functions

<span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
    start<span class="o">)</span>
        stat_busy <span class="s1">&#39;Starting PHP Fastcgi Server&#39;</span>
        <span class="k">if </span>su www -c <span class="s1">&#39;/usr/bin/php-cgi -b 127.0.0.1:9000&#39;</span> &amp;
        <span class="k">then</span>
<span class="k">            </span>add_daemon php-fastcgi
            stat_done
        <span class="k">else</span>
<span class="k">            </span>stat_fail       <span class="k">fi</span>
<span class="k">        fi</span>
        ;;
    stop<span class="o">)</span>
        stat_busy <span class="s1">&#39;Stopping PHP Fastcgi Server&#39;</span>
        <span class="o">[</span> -e /var/run/daemons/php-fastcgi <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> <span class="k">$(</span>pidof php-cgi<span class="k">)</span> &amp;&gt; /dev/null;
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -gt 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>stat_fail
        <span class="k">else</span>
<span class="k">            </span>rm_daemon php-fastcgi
            stat_done
        <span class="k">fi</span>
        ;;
   restart<span class="o">)</span>
        <span class="nv">$0</span> stop
        <span class="nv">$0</span> start
        ;;
   *<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;Usage: $0 {start|stop|restart}&quot;</span>
<span class="k">esac</span>
</code></pre>
<p>Now open <code>/etc/nginx/nginx.conf</code> again and add the following in each server
block where you want to use PHP.</p>
<pre class="highlight"><code><span class="c1"># PHP</span>
<span class="k">location</span> <span class="p">~</span> <span class="sr">\.php$</span> <span class="p">{</span>
    <span class="kn">fastcgi_pass</span>   <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
    <span class="kn">fastcgi_param</span>  <span class="s">SCRIPT_FILENAME</span>  <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
    <span class="kn">include</span>        <span class="s">fastcgi_params</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Now you&#39;re able to start and use PHP, but I recommend that you read through
<code>/etc/php/php.ini</code> to configure certain settings (look for <code>display_errors</code>
and the extensions). The file contains alot of comments that will explain
everthing.</p>

<p>Now you can start PHP with the following command:</p>
<pre class="highlight"><code><span class="gp">$</span> /etc/rc.d/php-fastcgi start
<span class="go">:: Starting PHP Fastcgi Server                                  [DONE]</span>
</code></pre>
<p>And you&#39;re done if you don&#39;t have any other PHP extensions to configure
(Xdebug, APC, Memcache).</p>

<p>I didn&#39;t bother to use PHP-FPM, because I would have to patch and build PHP
myself and that would take more time. Maybe another time. You can take a look
at <a href="http://php-fpm.org/">php-fpm.org</a> if you want PHP-FPM instead of the
method I used.</p>

<h2>phpMyAdmin</h2>

<p>phpMyAdmin will be used to manage all the MySQL databases.</p>

<p>Make sure the section for the phpMyAdmin subdomain looks like the following and
put it in <code>/etc/nginx/nginx.conf</code>.</p>
<pre class="highlight"><code><span class="c1"># phpmyadmin.isamu</span>
<span class="k">server</span> <span class="p">{</span>
   <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span>  <span class="s">phpmyadmin.isamu</span><span class="p">;</span>

    <span class="kn">root</span> <span class="s">/usr/share/webapps/phpMyAdmin</span><span class="p">;</span>
    <span class="kn">access_log</span>  <span class="s">/var/log/nginx/phpmyadmin.isamu.access.log</span>  <span class="s">main</span><span class="p">;</span>
    <span class="kn">autoindex</span> <span class="no">on</span><span class="p">;</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">index</span>  <span class="s">index.php</span> <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1"># PHP</span>
    <span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php$</span> <span class="p">{</span>
        <span class="kn">fastcgi_pass</span>   <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
        <span class="kn">fastcgi_param</span>  <span class="s">SCRIPT_FILENAME</span>  <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
        <span class="kn">include</span>        <span class="s">fastcgi_params</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1"># Redirect server error pages to the static page /50x.html</span>
    <span class="kn">error_page</span>   <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span>  <span class="s">/50x.html</span><span class="p">;</span>
    <span class="kn">location</span> <span class="p">=</span> <span class="s">/50x.html</span> <span class="p">{</span>
        <span class="kn">root</span> <span class="s">/srv/http/nginx/default</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="p">~</span> <span class="sr">/\.ht</span> <span class="p">{</span>
        <span class="kn">deny</span>  <span class="s">all</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Then open <code>/etc/php/php.ini</code> and add <code>:/usr/share/webapps/:/etc/webapps</code> to
<code>open_basedir</code> so it will look like:</p>
<pre class="highlight"><code><span class="na">open_basedir</span> <span class="o">=</span> <span class="s">/srv/http/:/home/:/tmp/:/usr/share/pear/:/usr/share/webapps/:/etc/webapps</span>
</code></pre>
<p>After you&#39;ve done that open <code>/etc/webapps/phpmyadmin/config.inc.php</code> and
configure everything. There are helpful comments everywhere so you shouldn&#39;t
have any problems.</p>
<pre class="highlight"><code><span class="gp">$</span> /etc/rc.d/nginx restart <span class="o">&amp;&amp;</span> /etc/rc.d/php-fastcgi restart
<span class="go">:: Checking configuration                                       [BUSY]</span>
<span class="go">the configuration file /etc/nginx/nginx.conf syntax is ok</span>
<span class="go">configuration file /etc/nginx/nginx.conf test is successful</span>
<span class="go">                                                                [DONE]</span>
<span class="go">:: Stopping Nginx                                               [DONE]</span>
<span class="go">:: Starting Nginx                                               [DONE]</span>
<span class="go">:: Stopping PHP Fastcgi Server                                  [DONE]</span>
<span class="go">:: Starting PHP Fastcgi Server                                  [DONE]</span>
</code></pre>
<p>More information about phpMyAdmin can be found at:</p>

<ul>
<li><a href="http://www.phpmyadmin.net/">phpMyAdmin</a></li>
<li><a href="http://wiki.archlinux.org/index.php/Phpmyadmin">phpMyAdmin at ArchWiki</a></li>
<li><a href="http://www.archlinux.org/packages/community/any/phpmyadmin/">phpMyAdmin Arch Linux package</a></li>
<li><a href="http://repos.archlinux.org/wsvn/community/phpmyadmin/repos/community-any/">PKGBUILD</a></li>
</ul>

<h2>Daemons</h2>

<p>To let MySQL, Nginx and PHP startup when your server starts up you can add
<code>mysqld</code>, <code>nginx</code> and <code>php-fastcgi</code> to the daemons list in <code>/etc/rc.conf</code>.</p>
<pre class="highlight"><code><span class="nv">DAEMONS</span><span class="o">=(</span>syslog-ng network netfs crond sshd postgresql mysqld nginx php-fastcgi<span class="o">)</span>
</code></pre>
<p>This is optional, but makes things a bit easier.</p>

<h2>That&#39;s it</h2>

<p>Yup. I also wanted to include PostgreSQL and phpPgAdmin in this article, but
for some reason PostgreSQL doesn&#39;t work. Maybe I&#39;ll add that later after I get
it working.</p>

<footer>
<ul class="tags">
<li><a href="http://61924.nl/tags/arch-linux/">arch-linux</a></li><li><a href="http://61924.nl/tags/nginx/">nginx</a></li><li><a href="http://61924.nl/tags/php/">php</a></li><li><a href="http://61924.nl/tags/phpmyadmin/">phpmyadmin</a></li>
</ul>
</footer>
</article>

</section>
<footer id="bottom">
<p>&copy; 2011-2012. <a href="https://github.com/FSX">Frank Smit</a>.</p>
</footer>
<script type="text/javascript" src="http://61924.nl/assets/js/ender.min.js"></script>
<script type="text/javascript" src="http://61924.nl/assets/js/jsimgbox2.min.js"></script>
<script type="text/javascript">
$.domReady(function () {
Jsimgbox.init($('a[title=jsimgbox]'));
});
</script>
</body>
</html>
