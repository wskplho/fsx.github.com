<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AtomParser — Blog — 61924.nl</title>
<!--[if IE]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<!-- <link rel="stylesheet/less" type="text/css" href="http://61924.nl/assetsscreen.less"> -->
<link href='http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link rel="stylesheet" type="text/css" href="http://61924.nl/assets/all.css">
<link rel="alternate" type="application/atom+xml" href="http://61924.nl/atom.xml" />
</head>
<body id="blog-section">
<nav id="navigation">
<h1>61924</h1>
<div>

<a id="nav-blog" href="http://61924.nl/">blog</a>

<a id="nav-archive" href="http://61924.nl/archive/">archive</a>

<a id="nav-projects" href="http://61924.nl/projects/">projects</a>

<a id="nav-about" href="http://61924.nl/about/">about</a>

</div>
</nav>
<section id="content">

<article class="post">
<header>
<h1>AtomParser</h1>
<h2>24 Apr 2010</h2>
</header>
<p>Someone needed a way to parse Atom feeds, since SimplePie was spitting out
errors in PHP 5.3. So I offered to write a small library to parse Atom feeds
(it should work with other XML stuff too).</p>

<p>It&#39;s a really simple PHP class that takes in a filepath (or URL) and gives you
an array back. And it also caches the result if you want that. The code can be
downloaded from <a href="http://gist.github.com/377548">Gist 377548</a>.</p>

<p>Here&#39;s an usage example:</p>
<pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">try</span>
<span class="p">{</span>
    <span class="nv">$p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AtomParser</span><span class="p">(</span><span class="s1">&#39;fluxbb.atom&#39;</span><span class="p">);</span>

    <span class="nb">print_r</span><span class="p">(</span><span class="nv">$p</span><span class="o">-&gt;</span><span class="na">parse</span><span class="p">());</span>
<span class="p">}</span>
<span class="k">catch</span> <span class="p">(</span><span class="nx">AtomParserException</span> <span class="nv">$e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">;</span>

    <span class="nb">print_r</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">get_libxml_errors</span><span class="p">());</span>
<span class="p">}</span>
</code></pre>
<p>Now, let&#39;s make it a bit more exciting by combining multiple feeds. First choose
some Atom feeds, put then in an array and parse them.</p>
<pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="k">E_ALL</span><span class="p">);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">&#39;Content-Type: text/plain; charset=utf-8&#39;</span><span class="p">);</span>

<span class="k">require</span> <span class="s1">&#39;atomparser.php&#39;</span><span class="p">;</span>

<span class="nv">$feedsurls</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;fluxbb-news&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;http://fluxbb.org/forums/feed/atom/forum/1/posted/&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fluxbb-dev&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;http://gitorious.org/fluxbb.atom&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fluxbb-discussion&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;http://fluxbb.org/forums/feed/atom/forum/14/last_post/&#39;</span>
    <span class="p">);</span>

<span class="c1">// Fetch and parse all the feeds</span>
<span class="nv">$feeds</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">$feedsurls</span> <span class="k">as</span> <span class="nv">$n</span> <span class="o">=&gt;</span> <span class="nv">$u</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$tmp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AtomParser</span><span class="p">(</span><span class="nv">$u</span><span class="p">);</span>
    <span class="nv">$feeds</span><span class="p">[</span><span class="nv">$n</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tmp</span><span class="o">-&gt;</span><span class="na">parse</span><span class="p">();</span>
<span class="p">}</span>
<span class="nb">unset</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">);</span>
</code></pre>
<p>After that we&#39;ve got to merge the entries from all the feeds and change the
date in the <em>updated</em> tag into a timestamp to make the sorting of all the
entries easier.</p>
<pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$entries</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$feeds</span> <span class="k">as</span> <span class="nv">$n</span> <span class="o">=&gt;</span> <span class="nv">$f</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$f</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$index</span> <span class="o">=&gt;</span> <span class="nv">$entry</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$f</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">][</span><span class="nv">$index</span><span class="p">][</span><span class="s1">&#39;website&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$n</span><span class="p">;</span>
        <span class="nv">$f</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">][</span><span class="nv">$index</span><span class="p">][</span><span class="s1">&#39;updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$entry</span><span class="p">[</span><span class="s1">&#39;updated&#39;</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="nv">$entries</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$entries</span><span class="p">,</span> <span class="nv">$f</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre>
<p>The sorting of the entries with PHP&#39;s <a href="http://php.net/manual/en/function.array-multisort.php">multisort</a>.</p>
<pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">$entries</span> <span class="k">as</span> <span class="nv">$res</span><span class="p">)</span> <span class="nv">$sort_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$res</span><span class="p">[</span><span class="s1">&#39;updated&#39;</span><span class="p">];</span>
<span class="nb">array_multisort</span><span class="p">(</span><span class="nv">$sort_entries</span><span class="p">,</span> <span class="nx">SORT_NUMERIC</span> <span class="o">|</span> <span class="nx">SORT_DESC</span><span class="p">,</span> <span class="nv">$entries</span><span class="p">);</span>
</code></pre>
<p>And display some data.</p>
<pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$entries</span> <span class="k">as</span> <span class="nv">$e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;Website: &#39;</span><span class="p">,</span> <span class="nv">$e</span><span class="p">[</span><span class="s1">&#39;website&#39;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">&#39;Title: &#39;</span><span class="p">,</span> <span class="nv">$e</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">&#39;Date: &#39;</span><span class="p">,</span> <span class="nb">date</span><span class="p">(</span><span class="s1">&#39;jS, F Y - H:i:s&#39;</span><span class="p">,</span> <span class="nv">$e</span><span class="p">[</span><span class="s1">&#39;updated&#39;</span><span class="p">]),</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>The code of this example can be found at <a href="http://gist.github.com/378363">Gist 378363</a>. Feel free to use it
in any way you want. For example: combine all your social media Atom feeds and
display them on your website.</p>

<footer>
<ul class="tags">
<li><a href="http://61924.nl/tags/php/">php</a></li><li><a href="http://61924.nl/tags/xml/">xml</a></li><li><a href="http://61924.nl/tags/atom/">atom</a></li>
</ul>
</footer>
</article>

</section>
<footer id="bottom">
<p>&copy; 2011-2012. <a href="https://github.com/FSX">Frank Smit</a>.</p>
</footer>
<script type="text/javascript" src="http://61924.nl/assets/js/ender.min.js"></script>
<script type="text/javascript" src="http://61924.nl/assets/js/jsimgbox2.min.js"></script>
<script type="text/javascript">
$.domReady(function () {
Jsimgbox.init($('a[title=jsimgbox]'));
});
</script>
</body>
</html>
