<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Whoosh! — Blog — 61924.nl</title>
<!--[if IE]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<!-- <link rel="stylesheet/less" type="text/css" href="http://0.0.0.0:8080/assetsscreen.less"> -->
<link href='http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link rel="stylesheet" type="text/css" href="http://0.0.0.0:8080/assets/all.css">
<link rel="alternate" type="application/atom+xml" href="http://0.0.0.0:8080/atom.xml" />
</head>
<body id="blog-section">
<nav id="navigation">
<h1>61924</h1>
<div>

<a id="nav-blog" href="http://0.0.0.0:8080/">blog</a>

<a id="nav-archive" href="http://0.0.0.0:8080/archive/">archive</a>

<a id="nav-projects" href="http://0.0.0.0:8080/projects/">projects</a>

<a id="nav-about" href="http://0.0.0.0:8080/about/">about</a>

</div>
</nav>
<section id="content">

<article class="post">
<header>
<h1>Whoosh!</h1>
<h2>19 Aug 2010</h2>
</header>
<p>A few days ago I found <a href="http://bitbucket.org/mchaput/whoosh/wiki/Home">Whoosh</a>. It is a fast, featureful full-text indexing
and searching library implemented in pure Python. And it doesn&#39;t require a lot
of code to get something useful.</p>

<p>In this post I&#39;ll show you how to make a simple search engine, which could be
used on a website like I do. I&#39;ll put everything into a simple class, a thin
wrapper around Whoosh, and add a piece in each example. The <code>...</code> is a
replacement of a piece of code from the previous example and is not needed in
the current example. Module imports will only be shown once per example. Just
add the imports from the previous examples to the one you&#39;re looking at.</p>

<p>Install Whoosh with <code>easy_install Whoosh</code> or <code>pip install Whoosh</code>. Or clone the
Mercurial repository with <code>hg clone http://bitbucket.org/mchaput/whoosh</code>.</p>

<p>First we need a schema that specifies the fields of a document in an index.
Take a look at <a href="http://packages.python.org/Whoosh/schema.html">Designing a schema</a> from the Whoosh documentation for more
information.</p>
<pre class="highlight"><code><span class="kn">import</span> <span class="nn">whoosh.fields</span>

<span class="k">class</span> <span class="nc">SearchEngine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">whoosh</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Schema</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="n">whoosh</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">ID</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stored</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">title</span><span class="o">=</span><span class="n">whoosh</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">TEXT</span><span class="p">(</span><span class="n">stored</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">phrase</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="n">content</span><span class="o">=</span><span class="n">whoosh</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">TEXT</span><span class="p">())</span>
</code></pre>
<p>That&#39;s the same one I use for this website. We&#39;ll only use <code>content</code> to search
through. <code>url</code> and <code>title</code> are going to be used to display the search results.
<code>url</code> is unique, becuase it&#39;ll be possible to update/re-index documents later.</p>
<pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">whoosh.index</span>

<span class="k">class</span> <span class="nc">SearchEngine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">index_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">index_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">index_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">whoosh</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">create_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_index</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">open_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">whoosh</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">open_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">.</span><span class="n">writer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">index_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">whoosh</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">exists_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="nb">unicode</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
            <span class="n">title</span><span class="o">=</span><span class="nb">unicode</span><span class="p">(</span><span class="n">title</span><span class="p">),</span>
            <span class="n">content</span><span class="o">=</span><span class="nb">unicode</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">update_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span><span class="o">.</span><span class="n">update_document</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="nb">unicode</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
            <span class="n">title</span><span class="o">=</span><span class="nb">unicode</span><span class="p">(</span><span class="n">title</span><span class="p">),</span>
            <span class="n">content</span><span class="o">=</span><span class="nb">unicode</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">delete_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">.</span><span class="n">delete_by_term</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">optimize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
</code></pre>
<p>Now the class has everything to create and modify the index. Start the search
engine with <code>SearchEngine(&#39;./somepath&#39;)</code>. The only argument you need to give is
the path where the index files are stored. If the directory does not exist it
will be created automatically. Call <code>create_index</code> or <code>open_index</code> to create or
open an index. One of these two must be called before you call <code>add_document</code>,
<code>update_document</code> and <code>delete_document</code>. After some documents have been added,
updated or deleted you can call <code>commit</code> or <code>cancel</code> if the changes don&#39;t need
to be stored.</p>

<p>Something that needs to be mentioned is that you need to strip the HTML from
your documents before you index them. Otherwise it gets indexed too and
you might get strange results. I use the following two functions to clean my
data.</p>
<pre class="highlight"><code><span class="kn">import</span> <span class="nn">re</span>

<span class="n">RE_GIST_JS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;&lt;script(?: type=&quot;text\/javascript&quot;)? src=&quot;&#39;</span>
    <span class="s">&#39;http:\/\/gist.github.com\/([0-9]+)\.js&quot;&gt;&lt;\/script&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">replace_gist_js</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RE_GIST_JS</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
        <span class="s">&#39;&lt;a href=&quot;http://gist.github.com/</span><span class="se">\1</span><span class="s">&quot;&gt;[Gist </span><span class="se">\1</span><span class="s">]&lt;/a&gt;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

<span class="n">REGEX_HTML_TAG</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;&lt;[^&lt;]*?/?&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">strip_html_tags</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">REGEX_HTML_TAG</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</code></pre>
<p>Here&#39;s an example. Store the code in <code>searchengine.py</code> and put a <code>__init__.py</code>
in the same directory then start a Python shell and change the working directory
to the one where you stored <code>searchengine.py</code>.</p>
<pre class="highlight"><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">searchengine</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">search</span> <span class="o">=</span> <span class="n">SearchEngine</span><span class="p">(</span><span class="s">&#39;./index&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">search</span><span class="o">.</span><span class="n">create_index</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">search</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="s">&#39;http://example.org/somedocument&#39;</span><span class="p">,</span>
<span class="go">    &#39;The document title&#39;, &#39;The content of the document&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">search</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre>
<p>Now we can create the function that does the searching for us. You should know
how to use this function.</p>
<pre class="highlight"><code><span class="kn">import</span> <span class="nn">whoosh.qparser</span>

<span class="k">class</span> <span class="nc">SearchEngine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">_queryparser</span> <span class="o">=</span> <span class="n">whoosh</span><span class="o">.</span><span class="n">qparser</span><span class="o">.</span><span class="n">QueryParser</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">querystring</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">.</span><span class="n">searcher</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_queryparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
            <span class="nb">unicode</span><span class="p">(</span><span class="n">querystring</span><span class="p">)),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</code></pre>
<p>Put this function in the SearchEngine class and put it in <code>searchengine.py</code>.
Start up the Python console, just like earlier.</p>
<pre class="highlight"><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">searchengine</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">search</span> <span class="o">=</span> <span class="n">SearchEngine</span><span class="p">(</span><span class="s">&#39;./index&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">search</span><span class="o">.</span><span class="n">open_index</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">search</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="s">&#39;http://example.org/somedocument_2&#39;</span><span class="p">,</span>
<span class="go">    &#39;Number 2&#39;, &#39;There is some content here.&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">search</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="s">&#39;http://example.org/somedocument_3&#39;</span><span class="p">,</span>
<span class="go">    &#39;Nothing...&#39;, &#39;But there\&#39;s nothing here. :(&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">search</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="s">&#39;http://example.org/somedocument_4&#39;</span><span class="p">,</span>
<span class="go">    &#39;Fantastic Four&#39;, &#39;Some stuff here!&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">search</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="s">&#39;http://example.org/somedocument_5&#39;</span><span class="p">,</span>
<span class="go">    &#39;Johnny Five&#39;, &#39;Pew pew pew!&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">search</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span>
<span class="go">&lt;Top 2 Results for Term(&#39;content&#39;, u&#39;content&#39;) runtime=0.0002169609&gt;</span>
</code></pre>
<p>It looks like it found 2 documents. We want to see those!</p>
<pre class="highlight"><code><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">result</span>
<span class="gp">...</span>
<span class="go">{&#39;url&#39;: u&#39;http://example.org/somedocument&#39;,</span>
<span class="go">    &#39;title&#39;: u&#39;The document title&#39;}</span>
<span class="go">{&#39;url&#39;: u&#39;http://example.org/somedocument_2&#39;,</span>
<span class="go">    &#39;title&#39;: u&#39;Number 2&#39;}</span>
</code></pre>
<p>And now with a score!</p>
<pre class="highlight"><code><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">result</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">])</span>
<span class="gp">...</span>
<span class="go">0.694600288045 - The document title: http://example.org/somedocument</span>
<span class="go">0.534820030092 - Number 2: http://example.org/somedocument_2</span>
</code></pre>
<p>Well, that&#39;s it. Now you should be able to use Whoosh for basic stuff, but I
recommend looking through the <a href="http://packages.python.org/Whoosh/">documentation</a> and the <a href="http://bitbucket.org/mchaput/whoosh/src/tip/src/whoosh/">source code</a>.
And this class doesn&#39;t have any error reporting or search query filtering, so
don&#39;t using it without adding those two first.</p>

<p>All the code from this post can be found at <a href="http://gist.github.com/538415">Gist 538415</a>.</p>

<footer>
<ul class="tags">
<li><a href="http://0.0.0.0:8080/tags/whoosh/">whoosh</a></li><li><a href="http://0.0.0.0:8080/tags/python/">python</a></li>
</ul>
</footer>
</article>

</section>
<footer id="bottom">
<p>&copy; 2011-2012. <a href="https://github.com/FSX">Frank Smit</a>.</p>
</footer>
<script type="text/javascript" src="http://0.0.0.0:8080/assets/js/ender.min.js"></script>
<script type="text/javascript" src="http://0.0.0.0:8080/assets/js/jsimgbox2.min.js"></script>
<script type="text/javascript">
$.domReady(function () {
Jsimgbox.init($('a[title=jsimgbox]'));
});
</script>
</body>
</html>
