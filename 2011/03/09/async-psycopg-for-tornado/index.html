<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Async Psycopg for Tornado — Blog — 61924.nl</title>
<!--[if IE]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link href='http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link rel="stylesheet" type="text/css" href="http://61924.nl/assets//all.css">
<link rel="alternate" type="application/atom+xml" href="http://61924.nl/atom-xml" />
</head>
<body id="blog-section">
<nav id="navigation">
<h1>61924</h1>
<div>

<a id="nav-blog" href="http://61924.nl/">blog</a>

<a id="nav-archive" href="http://61924.nl/archive">archive</a>

<a id="nav-projects" href="http://61924.nl/projects">projects</a>

<a id="nav-about" href="http://61924.nl/about">about</a>

</div>
</nav>
<section id="content">

<article class="post">
<header>
<h1>Async Psycopg for Tornado</h1>
<h2>09 Mar 2011</h2>
</header>
<p><strong>Update:</strong> I&#39;ve made a repositoryon Github: <a href="https://github.com/FSX/momoko">github.com/FSX/momoko</a>.</p>

<p>Since last week I&#39;ve been trying to get asynchronous <a href="http://initd.org/psycopg/">Psycopg</a> working with
<a href="http://www.tornadoweb.org/">Tornado</a> after I got some <a href="http://groups.google.com/group/python-tornado/browse_thread/thread/56b50ea629baf965">good help on the mailinglist</a>. I&#39;ve put the
code in a <strong><a href="https://gist.github.com/861193">gist on Github</a></strong>. An example is also included.</p>

<p>This should be considered alpha software since I didn&#39;t test it extensively.
And I&#39;ll put it in a library when it gets bigger.</p>

<p>Here&#39;s a small fragment of an example application:</p>
<pre class="highlight"><code><span class="kn">from</span> <span class="nn">async_psycopg2</span> <span class="kn">import</span> <span class="n">Pool</span>

<span class="k">class</span> <span class="nc">BaseHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="s">&#39;db&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span>
                <span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="s">&#39;localhost&#39;</span><span class="p">,</span>
                <span class="s">&#39;database&#39;</span><span class="p">:</span> <span class="s">&#39;somedatabase&#39;</span><span class="p">,</span>
                <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="s">&#39;someuser&#39;</span><span class="p">,</span>
                <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&#39;password&#39;</span><span class="p">,</span>
                <span class="s">&#39;async&#39;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">db</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT 42, 12, 40, 11;&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Query results: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</code></pre>
<p>I was considering trying to add a way to run multiple asynchronous queries in
one request, but I&#39;ll wait with that untill I need it in the project I&#39;m working
on.</p>

<footer>
<ul class="tags">
<li><a href="http://61924.nl/tags/tornado">tornado</a></li><li><a href="http://61924.nl/tags/psycopg2">psycopg2</a></li><li><a href="http://61924.nl/tags/python">python</a></li>
</ul>
</footer>
</article>

</section>
<footer id="bottom">
<p>&copy; 2011-2012. <a href="https://github.com/FSX">Frank Smit</a>.</p>
</footer>
<script type="text/javascript" src="http://61924.nl/assets//js/ender.min.js"></script>
<script type="text/javascript" src="http://61924.nl/assets//js/jsimgbox2.min.js"></script>
<script type="text/javascript">
$.domReady(function () {
Jsimgbox.init($('a[title=jsimgbox]'));
});
</script>
</body>
</html>
